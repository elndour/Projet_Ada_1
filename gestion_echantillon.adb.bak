WITH Ada.Text_IO, Ada.Float_Text_IO, Ada.Integer_Text_IO,gestion_personnel,gestion_date,Gestion_Outils,Gestion_Analyse,Gestion_Tube,ada.Directories,Ada.Characters.Handling;
use Ada.Text_IO, Ada.Float_Text_IO, Ada.Integer_Text_IO,gestion_personnel,gestion_date,Gestion_Outils,Gestion_Analyse,Gestion_Tube,ada.Directories,Ada.Characters.Handling;

PACKAGE BODY gestion_Echantillon IS
   USE Stockage_Echantillon;
   USE Stockage_Refrigerateur;
   Use Stockage_congelateur;
-- Fonction verification de l'identite du preleveur

   FUNCTION Est_Preleveur_Valide(Identifiant : T_Identite; T: T_Registre) RETURN Integer IS
    valeur:integer:=-1;
   BEGIN
      FOR i in T_Registre'RANGE LOOP
         IF T(i).Identite = Identifiant AND T(I).Fonction = Preleveur THEN
            valeur:= T(i).Identifiant;
         END IF;
      END LOOP;
      return valeur;

   END Est_Preleveur_Valide;
   -----------------------------------------------------------------------------
   PROCEDURE Affiche_Echantillon_V1(Tab : IN T_Registre_Prelevement; int : out integer) IS
   Id : Integer;
   trouv : boolean :=false;
   BEGIN
   Put("Identifiant:  ");
   Get(Id); Skip_Line;
   FOR I IN Tab'RANGE LOOP
      IF Tab(I).Id_Echantillon = Id THEN
         int := id;
         Put("Il s'agit d'un echantillon de "); Put(t_organe'image(Tab(Id).Organe)); Put(" recolte sur un(e) ");
            Put(T_Animaux'Image(Tab(Id).Animal)); Put(" le "); Afficher_Date(Tab(Id).Date_Prelevement);
            put(" par ");put(tab(id).identite_Preleveur.prenom);put(" ");put(tab(id).identite_Preleveur.Nom); New_Line;
         Put(Tab(Id).Nbr_Tubes); Put(" tubes ont ete crees ");
         trouv := true; EXIT;
      END IF;
   END LOOP;
   IF NOT Trouv THEN
      Put_line("L'Identifiant ne fait pas partie des identifiants dans echantillons : invalide");
   END IF;

   END Affiche_Echantillon_V1;
  ---------------------------------------------------------------------------------
PROCEDURE Affiche_Echantillon_V2(Tab : IN T_Registre_Prelevement) IS
   int : integer;
   BEGIN
      Affiche_Echantillon_V1(Tab,int);
      put_line("les voici");
      FOR I IN 1..tab(int).nbr_tubes LOOP
         Put("identifiant du tube: "); Put(I); New_Line;
         Put("Stockage dans le "); Put(T_Lieu'Image(Tab(int).Listes_Tubes(I).Endroit.Lieu));
         Put(" numero "); Put(tab(int).listes_tubes(i).endroit.numero);new_line;
      END LOOP;
   END Affiche_Echantillon_V2;
--fonction compter le nombre de places disponibles dans le refrigerateur
   function Places_Disponibles_R(Refri : T_Refrigerateur) return Integer is
         Total : Integer := 0;
   begin
        for J in Refri'Range loop
            Total := Total + Refri(J).Nbre_Place;
        end loop;
        return Total;
end Places_Disponibles_R;
   --------------------------------------------------------------------------------
--fonction compter le nombre de places disponibles dans le refrigerateur
   function Places_Disponibles_C(congel : T_Congelateur) return Integer is
         Total : Integer := 0;
   begin
        for J in congel'Range loop
            Total := Total + congel(J).Nbre_Place;
        end loop;
        return Total;
end Places_Disponibles_C;

--foction qui verifie est ce que tous les tubes sont analyses ou detruit.
function Tous_Tubes_Analyses(Echantillon : T_Echantillon)  return Boolean is
         bool:boolean:=false;
         bool2:boolean:=false;
         bool1:boolean:=false;

begin
   -- Parcourir tous les tubes de l'Ã©chantillon
   for I in 1..Echantillon.Nbr_Tubes loop
      -- Si un tube n'est pas analysÃ©, retourner False
      if Echantillon.Listes_Tubes(I).analyser then
         bool1:=true;
      end if;
      if not Echantillon.Listes_Tubes(I).detruit then
         bool2:=true;
      end if;
   end loop;
      if bool1 or else bool2 then
         bool:=true;
      end if;
      return bool; --retourne false si tous les tubes sont analyse ou detruits.
end Tous_Tubes_Analyses;

-- procedure pour detruire les tubes non analyses
procedure Verifier_Et_Detruire_Echantillons(Registre : in out T_Registre_Prelevement; Date_J: T_Date) is
begin
   for I in Registre'Range loop
      -- VÃ©rifier si la date de pÃ©remption est Ã©gale Ã  la date de prÃ©lÃ¨vement
      if Comparer_Date(Registre(I).Date_perimer,Date_J) then
         -- VÃ©rifier si les tubes ne sont pas analysÃ©s
         for J in 1..Registre(I).Nbr_Tubes loop
            if not Registre(I).Listes_Tubes(J).analyser then
               -- Marquer le tube comme dÃ©truit
               Registre(I).Listes_Tubes(J).detruit := True;
               Put_Line("Le Tube "); put(J); put (" de l'Ã©chantillon "); put(i); put(" a Ã©tÃ© dÃ©truit.");
            end if;
         end loop;
      end if;
   end loop;
end Verifier_Et_Detruire_Echantillons;

--procedure enregister tableau echantillon.
procedure Enregistrer_Tableau_Echantillons(echantillon : in out T_Registre_Prelevement;T: in out T_Registre;Nbr_Ech_Att : in out Integer;dateJ: in T_date) is
          K,Id_Preleveur:Integer;
          Refri : T_Refrigerateur;
          Congel : T_Congelateur;
          S : string(1..14);
          Reussi : Boolean;
          lieu : T_lieu;
          date:T_date;
          Id:Integer:=1;
          Ident : T_Identite;
          Trouv : Boolean:=False;
          max: integer :=0;
begin
   Recup_Stockage_Congel(Congel);
   Recup_Stockage_refri(refri);
   for I in echantillon'Range loop
      -- VÃ©rifier si la case est vide ou dÃ©jÃ  utilisÃ©e
      if echantillon(I).Nbr_Tubes = 0 then
         trouv :=True;
         Put("Enregistrement de l'echantillon ");put(I); New_Line;
      -- VÃ©rification de l'identitÃ© du prÃ©leveur
         ident.Nom := (OTHERS => ' ');
         ident.prenom := (OTHERS => ' ');
         Put_Line("Donner le nom du preleveur qui a prelever le tube");
             get_line(ident.nom,k);
             Put_Line("Donner le prenom du preleveur qui a prelever le tube");
             get_line(ident.prenom,k);

        Id_preleveur:=Est_Preleveur_Valide(ident,T);

        if Id_preleveur=-1 THEN
        Put_Line("Soit c'est un analyste, soit l'identitÃ© n'existe pas");

        ELSE
               if nbr_ech_att > nbr_max_echantillon  then
                  Put_Line("Le nombre de place maximale est atteinte");
            ELSE
               Echantillon(i).identite_preleveur := ident;
               Nbr_Ech_Att:=Nbr_Ech_Att+1;
               FOR I IN echantillon'RANGE LOOP
                  IF Echantillon(i).Nbr_Tubes /= 0 THEN
                     IF echantillon(I).Id_echantillon  > max THEN
                        max := echantillon(I).id_echantillon;
                     END IF;
                   end if;
               END LOOP;
           echantillon(i).id_echantillon := max +1;
        -- affichage du stokgae disponibles dans le frigo ou refrigerteur;
                  Put("Nombre de places disponibles dans les refrigerateurs : ");
                  Put(Places_Disponibles_R(Refri));New_Line;
                  Put("Nombre de places disponibles dans les congelateurs : ");
                  Put(Places_Disponibles_C(Congel));New_Line;

      -- VÃ©rification et enregisrement du nombre de tubes
                    loop
                        Put_Line("Donner le nombre de tube de l'echantillon");
                        get(echantillon(i).Nbr_Tubes);skip_line;
                    exit WHEN echantillon(i).Nbr_Tubes > 0 or else echantillon(i).Nbr_Tubes < 6 ;
                        Put_Line("Le nombre de tubes doit Ãªtre entre 1 et 5.");
                    end loop;

-- enregistrement de l'animal

                    Put_Line("De quel animal l'echantillon a ete prelever");
                    get_line(s,k);
                    echantillon(i).animal:=T_animaux'value(s(1..k));

-- enregistrement de l'organe

                    Put_Line("De quel organe l'echantillon a ete prelever");
                    get_line(s,k);
                    echantillon(i).organe:=T_organe'value(s(1..k));

 -- Enregistrement des tubes au niveau de leur stokage.

               FOR t IN 1..Echantillon(i).Nbr_Tubes LOOP

                  Put_Line("donner le lieu de stockage: refrigerateur ou congelateur");
                  put("tube: ");put(t);put(" ");
                  get_line(s,k);
                  Lieu := T_Lieu'Value(S(1..K));
                  date:=datej;
                IF Lieu = REFRIGERATEUR THEN

                     FOR J IN refri'range LOOP

                           IF Refri(j).Nbre_Place > 0 THEN
                              Echantillon(i).Listes_Tubes(t).Endroit.Lieu := Lieu;
                              Echantillon(i).Listes_Tubes(t).Endroit.Numero := j;
                              Refri(J).Nbre_Place := Refri(J).Nbre_Place -1;
                              Echantillon(i).date_prelevement:=date;
                              Date_destruction_C(date);
                              Echantillon(I).Date_Perimer:=Date; new_line;
                              Put_Line("Tube stocker avec succe");
                              Stokage_refri(refri);exit;
                           END IF;
                     END LOOP;
                  ELSIF Lieu = CONGELATEUR THEN
                     --Put("Donner le numero de refrigerateur..1 ou 2 ou 3 ou 4 ou 5");
                     --   Get(N); Skip_Line;
                     FOR J IN Congel'RANGE LOOP

                              IF congel(j).Nbre_Place > 0 THEN

                                 Echantillon(i).Listes_Tubes(t).Endroit.Lieu := Lieu;
                                 Echantillon(i).Listes_Tubes(t).Endroit.Numero := j;
                                 congel(J).Nbre_Place := congel(J).Nbre_Place -1;
                                 Echantillon(i).date_prelevement:=dateJ;
                                 Date_destruction_C(date);
                                 echantillon(i).Date_perimer:=date; new_line;
                                 Put_Line("Tube stocker avec succes");
                                 Stokage_congel(congel);exit;
                              END IF;
                        END LOOP;
                     END IF;
               END LOOP;
               Put_Line ("Prelevement enregistrer avec succes");
              -- incrementation du nombre d'actes pour cette analyste.

                  for i in T'RANGE loop
                      if T(i).Identifiant=Id_preleveur then
                         T(I).Nbr_Act_Realiser:=T(I).Nbr_Act_Realiser+1;
                         --put(T(I).Nbr_Act_Realiser);
                      end if;
               END LOOP;

         END IF;
         END IF; exit;
         put_line("Le registre des echantillons est pleins");
      end if;
   END LOOP;
   if not trouv then
      Put("La liste des echantillons: n°");
   END IF;
    Stokage_echantillon(echantillon);
END Enregistrer_Tableau_Echantillons;

-----------------------------------------------------------------------------------
   PROCEDURE Stokage_echantillon(ech:IN OUT T_Registre_Prelevement)is
      Echantillon_stockage : Stockage_echantillon.File_Type;
   begin
      IF exists("Stockage_echantillon") THEN
         Open(Echantillon_stockage, out_File,"Stockage_echantillon");
      ELSE
         Create(Echantillon_stockage, Name =>"Stockage_echantillon");
      END IF;
      Write(echantillon_stockage, ech);
      Close (echantillon_stockage);
   END Stokage_echantillon;
   ----------------------------------------------------------------------------------------
   PROCEDURE Recup_Stockage_ech(ech:IN OUT T_Registre_Prelevement) IS
      Echantillon_stockage : Stockage_echantillon.File_Type;
   begin
      IF exists("Stockage_echantillon") THEN
         Open(echantillon_stockage, in_File,"Stockage_echantillon");
         WHILE not End_Of_File(Echantillon_stockage) LOOP
            read(Echantillon_stockage, ech);
         END LOOP;
         Close (Echantillon_stockage);
      END IF;
   END Recup_Stockage_Ech;
   ---------------------------------------------------------------------------
   PROCEDURE Affich_Echantillon(Ech:IN T_Registre_Prelevement) IS
   trouv : boolean:=false;
   BEGIN
      --Recup_Stockage_Ech(Ech);
      FOR I IN ech'RANGE LOOP
         IF Ech(i).Nbr_Tubes /= 0 THEN
            Trouv := True;
         END IF;
      END LOOP;
      if trouv then
         put("La liste des echantillons: n°");
         FOR I IN Ech'RANGE LOOP
            IF Ech(i).Nbr_Tubes /= 0 THEN
               Put(Ech(I).Id_Echantillon); Put(",");
            END IF;
         END LOOP;
      ELSE
         Put("Il y'a pas encore d'echantillon");
      END IF;
      new_line;
   END Affich_Echantillon;   -----------------------------------------------------------------------------------
   PROCEDURE Stokage_refri(refri:IN OUT T_refrigerateur)is
      refrigerateur_stockage : Stockage_refrigerateur.File_Type;
   begin
      IF exists("Stockage_refrigerateur") THEN
         Open(refrigerateur_stockage, out_File,"Stockage_refrigerateur");
      ELSE
         Create(refrigerateur_stockage , Name =>"Stockage_refrigerateur");
      END IF;
      Write(refrigerateur_stockage , refri);
      Close (refrigerateur_stockage);
   END Stokage_refri;
   ----------------------------------------------------------------------------------------
   PROCEDURE Recup_Stockage_refri(refri:IN OUT T_refrigerateur) IS
      refrigerateur_stockage : Stockage_refrigerateur.File_Type;

   begin
      IF exists("Stockage_refrigerateur") THEN
         Open(refrigerateur_stockage, in_File,"Stockage_refrigerateur");
         WHILE not End_Of_File(refrigerateur_stockage) LOOP
            read(refrigerateur_stockage, refri);
         END LOOP;
         Close (refrigerateur_stockage);
      END IF;
   END Recup_Stockage_refri;
   ---------------------------------------------------------------------------
   PROCEDURE Stokage_congel(congel:IN OUT T_congelateur)is
      congelateur_stockage : Stockage_congelateur.File_Type;
   begin
      IF exists("Stockage_congelateur") THEN
         Open(congelateur_stockage, out_File,"Stockage_congelateur");
      ELSE
         Create(congelateur_stockage , Name =>"Stockage_congelateur");
      END IF;
      Write(congelateur_stockage , congel);
      Close (congelateur_stockage);
   END Stokage_congel;
   ----------------------------------------------------------------------------------------
   PROCEDURE Recup_Stockage_congel(congel:IN OUT T_congelateur) IS
      congelateur_stockage : Stockage_congelateur.File_Type;

   begin
      IF exists("Stockage_congelateur") THEN
         Open(congelateur_stockage, in_File,"Stockage_congelateur");
         WHILE not End_Of_File(congelateur_stockage) LOOP
            read(congelateur_stockage, congel);
         END LOOP;
         Close (congelateur_stockage);
      END IF;
   END Recup_Stockage_congel;
   ---------------------------------------------------------------------------
   PROCEDURE Enregistrer_Analyse(ech : IN OUT T_registre_prelevement;T:in out t_registre;datej: in T_date) IS
   k,id_analyste:integer;
   date:T_date:=datej;
   Date_Ana:T_Date;
   Ident : T_Identite;
   numTub, numEch : integer;
   s : string(1..13);
   BEGIN

      -- verification de l'identite de l'analyste.
             ident.Nom := (others => ' ');
             ident.Prenom := (others => ' ');

             Put_Line("Donner le nom de l'analyste qui a analyser le tube");
             get_line(ident.nom,k);

        Put_Line("Donner le prenom de l'analyste qui a analyser le tube");
             get_line(ident.prenom,k);

        id_analyste:=Est_Analyste_Valide(ident,T);

        if id_analyste=-1 THEN
        Put_Line("Soit c'est un preleveur, soit l'identitte n'existe pas");

        ELSE
            -- saisi de la date d'analyse.

             Put_Line("Saisie de la date de l'analyse");
             saisir_DATE(date_ana);
             if Comparer_Date(date_ana,date) then
                   Put("Donner le numero echantillon");
                   get(numEch); skip_line;
                   put("Donner le numero de tube");
                   get(numTub); skip_line;
                   for i in ech'range loop
                      IF Numech = I THEN
                         for j in ech(i).listes_tubes'range loop
                            if numTub = j then
                               --if not ech(i).listes_tubes(j).analyser then
                                  --if not ech(i).listes_tubes(j).detruit then
                                     ech(i).listes_tubes(j).analyser = True;
                                     put_line("Donner le resultat de l'analyse");
                                     Get_Line(S,K);
                                     ech(i).listes_tubes(j).analyse.resultat := T_resultat'value(s(1..k));
                                     ech(i).listes_tubes(j).analyse.Date_Analyse:=date_ana;
                                     tube.analyse.Identite_Analyste.Nom := ident.nom;
                                     ech(i).listes_tubes(j).Analyse.Identite_Analyste.Prenom := Ident.Prenom;
                                     ech(i).listes_tubes(j).Analyse.Identite_Analyste.Nom := ident.nom;
                                     --ech(i).listes_tubes(j).Analyse.Identifiant_analyste := id_analyste;
                                     Put_Line("Analyse enregistree avec succes.");

                                     -- incrementation du nombre d'actes pour cette analyste.
                                     for i in T'RANGE loop
                                        if T(i).Identifiant=id_analyste then
                                           T(I).Nbr_Act_Realiser:=T(I).Nbr_Act_Realiser+1;
                                        end if;
                                     end loop;

                                   --else
                                      put_line("Le tube a ete detruit");
                                   --end if;
                                --else
                                    put_line("Le tube est deja analyser");
                                --end if;
                             else
                                put_line("Le tube n'existe pas dans l'echantillon donnee");
                             end if;
                          end loop;
                       else
                          put_line("L'echantillon que vous avez donnee n'existe pas");
                       end if;
                    end loop;
            else
                     Put_line("La date n'est pas la date du jour");
            end if;
      end if;

   END Enregistrer_Analyse;

end gestion_Echantillon;